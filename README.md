# MU-PP Mark

This repository provides a **generation-time watermarking framework for Stable Diffusion**, together with a **watermark extraction and detection pipeline**.

The code supports:

- Watermark embedding during image generation  
- Dataset-level watermark generation  
- Single-image watermark injection  
- CLIP-based watermark extraction and identification  

---

## 1. Environment Setup

### 1.1 Requirements

- Python 3.8  
- CUDA 11.3 (recommended)  
- NVIDIA GPU (strongly recommended)

### 1.2 Install Dependencies

Create and activate a virtual environment (recommended):

```bash
conda create -n ldm python=3.8
conda activate ldm
pip install -r requirements.txt
``` 


## 2. Project Structure

```text
stable-diffusion/
├── 1.watermark-injectiondataset-marking/     
│   └── dataset-marking               # Dataset-level watermark generation ，Users can design their own dataset construction  
│   └──single-marking/                # Single-image watermark injection
│   └──watermarks.pt                  # Stored watermark templates
│   └── model.pth                     # Trained watermark detection model
│
├── train/                            # Watermark detector training and inference
│   ├── train.py
│   ├── inference.py
│   └── ...
│
│
├── requirements.txt
└── README.md
``` 
## 3. Dataset-level Watermark Generation

The `dataset-marking/` module is used to generate **watermarked datasets** for training or evaluation.

This part is **fully customizable**: users can design their own dataset structure, watermark content, and embedding strategy according to their needs.

### Usage

1. Prepare your prompt.
2. Implement or modify the watermark embedding logic inside `dataset-marking/`.
3. Run the corresponding script to generate a watermarked dataset.

> **Note:**  
> This module is intended for large-scale data generation. The watermark design and dataset format are left to the user for flexibility.

---
## 4. Single-image Watermark Injection

The `single-marking/` module is designed for embedding a watermark into **a single image**.

This is useful for:
- Demonstrations
- Ablation studies
- Qualitative visualization

### Usage

```bash
python single-marking.py
``` 
## 5. Training the Watermark Detector

The watermark detector is trained using watermarked images generated by the dataset-level .

### 5.1 Data Preparation

Before training, prepare a dataset containing:
- Watermarked images
- Corresponding watermark labels or indices

The dataset format follows the implementation inside the `train/` directory.  
Users may customize the dataset organization if needed.

---

### 5.2 Training

To start training the watermark detector, run:

```bash
cd train
python train.py

```
## 6. Watermark Detection (Inference)

After training, the watermark detector can be used to identify the embedded watermark from a given image.

### 6.1 Inference

To run watermark detection on a single image, execute:

```bash
cd train
python inference.py --image path/to/image.png







